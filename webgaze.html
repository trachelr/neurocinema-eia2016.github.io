<!DOCTYPE html>
<html >
    <head>
        <meta charset="UTF-8">
        <title>An emotion-based video player</title>
        <link rel="stylesheet" href="css/style.css">
        <link rel="stylesheet" href="css/emoticon.css">
        <link type="text/css" rel="stylesheet" href="css/video-js.min.css" />
        <script>
            // getUserMedia only works over https in Chrome 47+, so we redirect to https. Also notify user if running from file.
            if (window.location.protocol == "file:") {
                alert("You seem to be running this example directly from a file. Note that these examples only work when served from a server or localhost due to canvas cross-domain restrictions.");
            } else if (window.location.hostname !== "localhost" && window.location.protocol !== "https:"){
                window.location.protocol = "https";
            }
        </script>
    </head>
    <body>
        <script src="./js/video.js/video.min.js"></script>
        <script src="./js/video-js/video.js"></script>
        <script src="./js/utils.js"></script>
        <script src="./js/clmtrackr/clm.js"></script>
        <script src="./js/clmtrackr/clmtrackr.js"></script>
        <script src="./js/models/model_pca_20_svm_emotionDetection.js"></script>
        <script src="./js/clmtrackr/Stats.js"></script>
        <script src="./js/models/d3.min.js"></script>
        <script src="./js/models/emotion_classifier.js"></script>
        <script src="./js/models/emotionmodel.js"></script>
        <script src="js/webgazer.js" type="text/javascript"></script>
        <script src="js/math.js" type="text/javascript"></script>

        <div id="container">
            <video id="videoel" width="400" height="300" preload="auto" loop></video>
            <canvas id="overlay" width="400" height="300"></canvas>
        </div>
        <div style="height: 100%;">
            <div id="player"></div>
        </div>
        <script>
            $(function () {
                $("#player").mediaPlayer({
                    autoplay: false,
                    src: "media/Beetlejuice french scene - YouTube_360p.mp4",
                    controlBar: {
                        autohide: false
                    },
                    callbacks: {
                        onReady: 'onReady'
                    }

                });//.toggleFullScreen();
            });
        </script>
        <script src="https://www.gstatic.com/firebasejs/3.1.0/firebase.js"></script>
        <script>
            var vid = document.getElementById('videoel');
            var overlay = document.getElementById('overlay');
            var overlayCC = overlay.getContext('2d');
            
            /********** check and set up video/webcam **********/

            function enablestart() {
                var startbutton = document.getElementById('startbutton');
                startbutton.value = "start";
                startbutton.disabled = null;
            }
            
            navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
            window.URL = window.URL || window.webkitURL || window.msURL || window.mozURL;

            // check for camerasupport
            if (navigator.getUserMedia) {
                // set up stream
                
                var videoSelector = {video : true};
                if (window.navigator.appVersion.match(/Chrome\/(.*?) /)) {
                    var chromeVersion = parseInt(window.navigator.appVersion.match(/Chrome\/(\d+)\./)[1], 10);
                    if (chromeVersion < 20) {
                        videoSelector = "video";
                    }
                };
            
                navigator.getUserMedia(videoSelector, function( stream ) {
                    if (vid.mozCaptureStream) {
                        vid.mozSrcObject = stream;
                    } else {
                        vid.src = (window.URL && window.URL.createObjectURL(stream)) || stream;
                    }
                    vid.play();
                }, function() {
                    //insertAltVideo(vid);
                    alert("There was some problem trying to fetch video from your webcam. If you have a webcam, please make sure to accept when the browser asks for access to your webcam.");
                });
            } else {
                //insertAltVideo(vid);
                alert("This demo depends on getUserMedia, which your browser does not seem to support. :(");
            }

            function startVideo() {
                // start video
                vid.play();
                // start tracking
                ctrack.start(vid);
                // start loop to draw face
                drawLoop();
            }

            window.onload = function() {
                webgazer.setRegression('ridge') /* currently must set regression and tracker */
                    .setTracker('clmtrackr')
                    .setGazeListener(function(data, clock) {
                    //   console.log(data); /* data is an object containing an x and y key which are the x and y prediction coordinates (no bounds limiting) */
                    //   console.log(clock); /* elapsed time in milliseconds since webgazer.begin() was called */
                    if(!data)
                        return;
                    })
                    .begin()
                    .showPredictionPoints(true); /* shows a square every 100 milliseconds where current prediction is */

                var width = vid.width; //320;
                var height = vid.height; //240;
                var topDist = '0px';
                var leftDist = '0px';
                
                var setup = function() {
                    var video = document.getElementById('webgazerVideoFeed');
                    video.style.display = 'block';
                    video.style.position = 'absolute';
                    video.style.top = topDist;
                    video.style.left = leftDist;
                    video.width = width;
                    video.height = height;
                    video.style.margin = '0px';

                    webgazer.params.imgWidth = width;
                    webgazer.params.imgHeight = height;

                    var overlay = document.createElement('canvas');
                    overlay.id = 'overlay';
                    overlay.style.position = 'absolute';
                    overlay.width = width;
                    overlay.height = height;
                    overlay.style.top = topDist;
                    overlay.style.left = leftDist;
                    overlay.style.margin = '0px';

                    document.body.appendChild(overlay);

                    var cl = webgazer.getTracker().clm;

                    function drawLoop() {
                        requestAnimFrame(drawLoop);
                        overlay.getContext('2d').clearRect(0,0,width,height);
                        if (cl.getCurrentPosition()) {
                            cl.draw(overlay);
                        }
                    }
                    drawLoop();
                };

                function checkIfReady() {
                    if (webgazer.isReady()) {
                        setup();
                    } else {
                        setTimeout(checkIfReady, 100);
                    }
                }
                setTimeout(checkIfReady,100);
            };

            window.onbeforeunload = function() {
                //webgazer.end(); //Uncomment if you want to save the data even if you reload the page.
                window.localStorage.clear(); //Comment out if you want to save data across different sessions 
            }
        </script>
    </body>
</html>
