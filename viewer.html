<!DOCTYPE html>
<html>
    <head>
        <title>Timeline viewer</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" href="images/favicon.ico">
        <link href="css/default.css" rel="stylesheet">

        <script src="./js/utils.js"></script>
        <script src="./js/clmtrackr/clm.js"></script>
        <script src="./js/clmtrackr/clmtrackr.js"></script>
        <script src="./js/models/model_pca_20_svm_emotionDetection.js"></script>
        <script src="./js/clmtrackr/Stats.js"></script>
        <script src="./js/models/d3.min.js"></script>
        <script src="./js/models/emotion_classifier.js"></script>
        <script src="./js/models/emotionmodel.js"></script>

        <script src="https://www.gstatic.com/firebasejs/3.1.0/firebase.js"></script>
        <script src="js/webgazer.js" type="text/javascript"></script>
        <script src="js/math.js" type="text/javascript"></script>
    </head>
    <body>
        <div id="container">
            <video id="videoel" width="400" height="300" preload="auto" loop></video>
            <canvas id="overlay" width="400" height="300"></canvas>
        </div>

        <div id="controls">
            <input class="btn" type="button" value="wait, loading video" disabled="disabled" onclick="startVideo()" id="startbutton"></input>
            <input class="btn" type="button" value="show" disabled="enabled" onclick="showPlayer()" id="startplayer"></input>
        </div>
        
        <video id="youtube_player" data-setup="{}" controls="" hidden>
            <source src="media/Beetlejuice french scene - YouTube_360p.mp4" type="video/mp4">
        </video>

        <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyBI1lAq_sWUkSyuw6_q9Tp4Xq57pTqQLUU",
            authDomain: "neurocinema-a859d.firebaseapp.com",
            databaseURL: "https://neurocinema-a859d.firebaseio.com",
            storageBucket: "neurocinema-a859d.appspot.com",
        };
        firebase.initializeApp(config);

        var today = new Date();
        var day = parseInt(today.toISOString().replaceAll('-','').split('T')[0])
        var data = 'emotion'
        var path = today.toISOString().replaceAll(':','') + '/' + data
        path = path.replaceAll('-','').replace('.','')

        /*********** setup of emotion detection *************/
        var last = ""; //["", "", "", ""];
        var timestamp = ""; //["", "", "", ""];
        var enames = ["angry", "sad", "surprised", "happy"]
        var ctrack = new clm.tracker({useWebGL : true});
        ctrack.init(pModel);
        
        for (var i = 0;i < enames.length; i++) {
            // init firebase
            firebase.database().ref(path + '/' + enames[i]).set({
                localisation: [{
                    sublocalisations: {
                        localisation: [],
                    },
                    type: "segments",
                    tcin: "00:00:00.0000",
                    tcout: "00:60:00.0000",
                    tclevel: 0
                }],
                id: enames[i],
                type: "segments",
                algorithm: "clmtrackr",
                processor: "R. Trachel",
                processed: day,
                version: 1
            });
        }

        var xdata = [];
        var ydata = [];
        var data = 'gaze'
        var path = today.toISOString().replaceAll(':','') + '/' + data
        path = path.replaceAll('-','').replace('.','')

        // init firebase
        firebase.database().ref(path).set({
            localisation: [{
                sublocalisations: {
                    localisation: [],
                },
                label: "EllipseWithBoudingBox-1",
                tcin: "00:00:00.0000",
                tcout: "00:60:00.0000",
                tclevel: 0
            }],
            id: 'gaze-overlay',
            type: "visual_tracking",
            algorithm: "ridge",
            processor: "R. Trachel",
            processed: 0, //parseInt(path.split('T')[0]),
            version: 1
        });
        
        function writeEmotionSegment(videoID, min, sec, ms) {
            if (last == "") {
                last = videoID
            }
            if (timestamp == "") {
                timestamp = "00:".concat(min).concat(":").concat(sec).concat(".").concat(ms)
            } else {
                if (last == videoID) {
                    // remember only the first time stamp
                    console.log('dont save timestamp...')
                } else {
                    console.log('writing timestamp' + timestamp)
                    var ref = firebase.database().ref(path + '/' + videoID + '/localisation/0/sublocalisations/localisation');
                    // sync down from server
                    var list = [];
                    ref.on('value', function(snap) { list = snap.val(); });
                    // this is the correct way to change an array
                    list.push({
                        tcin: timestamp,
                        tcout: "00:".concat(min).concat(":").concat(sec).concat(".").concat(ms),
                        tclevel: 1
                    });
                    ref.set(list);
                    timestamp = "";
                    last = "";
                }
            }
        }

        function drawLoop() {
            requestAnimFrame(drawLoop);
            //overlayCC.clearRect(0, 0, 400, 300);
            //psrElement.innerHTML = "score :" + ctrack.getScore().toFixed(4);
            //if (ctrack.getCurrentPosition()) {
            //    ctrack.draw(overlay);
            //}
            var cp = ctrack.getCurrentParameters();
            var er = ec.meanPredict(cp);
            var ts = videojs('youtube_player').currentTime();
            if (er) {
                for (var i = 0;i < er.length;i++) {
                    if (er[i].value > 0.8) {
                        console.log(enames[i] + ': ' + er[i].value)
                        var minnow = String(ts / 60).split('.')[0].pad(2);
                        var secnow = String(ts).split('.')[0].pad(2);
                        var msnow = String(String(ts).split('.')[1]).substr(0,4)
                        writeEmotionSegment(enames[i], minnow, secnow, msnow);
                    }
                }
            }
        }
        
        var ec = new emotionClassifier();
        ec.init(emotionModel);
        var emotionData = ec.getBlank();    
        
        function writeUserGaze(x, y, timestamp) {
            var ref = firebase.database().ref(path + '/localisation/0/sublocalisations/localisation');
            // sync down from server
            var list = [];
            ref.on('value', function(snap) { list = snap.val(); });
            x = x / viewportwidth;
            y = y / viewportheight;
            // this is the correct way to change an array
            list.push({
                shape: {
                    t: "ellipse",
                    c: {
                        x: x,
                        y: y
                    },
                    rx: 0.01,
                    ry: 0.01,
                    o: 0.0
                },
                tc: timestamp,
                tclevel: 1
            });
            ref.set(list);
        }

        window.onload = function() {
            webgazer.setRegression('ridge') /* currently must set regression and tracker */
            .setTracker('clmtrackr')
            .setGazeListener(function(data, clock) {
                //   console.log(data); /* data is an object containing an x and y key which are the x and y prediction coordinates (no bounds limiting) */
                //   console.log(clock); /* elapsed time in milliseconds since webgazer.begin() was called */
                if(!data)
                    return;

                if (xdata.length == 10) {
                    var ts = videojs('youtube_player').currentTime();
                    var min = String(ts / 60).split('.')[0].pad(2);
                    var sec = String(ts).split('.')[0].pad(2);
                    var ms = String(String(ts).split('.')[1]).substr(0,4)
                    timestamp = "00:".concat(min).concat(":").concat(sec).concat(".").concat(ms)
                    if (ts > 0) {
                        writeUserGaze(math.mean(xdata), math.mean(ydata), timestamp);
                    }
                    xdata = [];
                    ydata = [];
                } else {
                    xdata.push(data.x);
                    ydata.push(data.y);
                }

                })
                .begin()
                .showPredictionPoints(true); /* shows a square every 100 milliseconds where current prediction is */
            
            var setup = function() {
                var cl = parent.cl //webgazer.getTracker().clm;
            };

            function checkIfReady() {
                if (webgazer.isReady()) {
                    setup();
                } else {
                    setTimeout(checkIfReady, 100);
                }
            }
            setTimeout(checkIfReady,100);
        };
        </script>
    </body>
</html>